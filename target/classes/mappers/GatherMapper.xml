<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	    
	    
    <mapper namespace="com.spring.hexagon.persistence.GatherDAO">
    
    	
    	
    	<!-- 계 목록 -->
    	<select id="gath_list" resultType="com.spring.hexagon.vo.GatherVO">
    		select *
			from gath_tbl
			where gath_state='0'
    	</select>
    	
    	<!-- 계 생성 -->
    	<insert id="gath_add" parameterType="com.spring.hexagon.vo.GatherVO">
	    	insert into GATH_TBL(rate,GATH_EX,GATH_TERM,GATH_GOAL,
			GATH_MONTH_PAY,GATH_IMG,GATH_NAME,
			GATH_NUM,GATH_MEMBER_NUM,
			GATH_TAX,GATH_CATEGORY) 
			
			values (#{rate},#{GATH_EX},#{GATH_TERM},#{GATH_GOAL},
			#{GATH_MONTH_PAY},#{GATH_IMG},#{GATH_NAME},
			gath_tbl_seq.nextval,0,
			5,#{GATH_CATEGORY})
    	</insert>
    	
    	<!-- 계 상세페이지 -->
    	<select id="gath_detail" parameterType="int" resultType="com.spring.hexagon.vo.GatherVO">
    		Select *
    		from gath_tbl
    		where GATH_NUM = #{GATH_NUM}
    	</select>
    	
    	<!-- 이자률 -->
    	<select id="gath_detail2" parameterType="int" resultType="com.spring.hexagon.vo.Gath_rateVO">
    		Select *
    		from gath_rate_tbl
    		where rate = #{rate}
    	</select>
    	
    	
    	<!-- 계 삭제 -->
    	<delete id="gath_del">
    		delete gath_tbl
			where gath_num = #{gath_num}
    	</delete>
    	
		<!-- 계 참가 -->
		<insert id="gath_join" parameterType="com.spring.hexagon.vo.Gath_buyVO">
			
			insert into GATH_BUY_TBL(gath_ref_date,GATH_PAYBACK_DATE,GATH_MONTH_PAY
			,GATH_NUM,GATH_BUY_NO,GUESTID
			,GATH_BUY_DATE,GATH_ACTUAL_RATE,GATH_TURN
			)
			values (
			#{gath_ref_date}
			, add_months(SYSDATE , #{GATH_TURN} )
			,#{GATH_MONTH_PAY}
			,#{GATH_NUM} ,gath_buy_tbl_seq.nextval ,#{GUESTID}
			,sysdate ,#{GATH_ACTUAL_RATE} ,#{GATH_TURN}
			)
		</insert>
		
		<update id="gath_join2" parameterType="java.util.Map">
			update gath_tbl
			set ${GATH_TURN} = #{guestid}
			where GATH_NUM = #{GATH_NUM}
		</update>
		<select id="gath_chk" parameterType="com.spring.hexagon.vo.Gath_buyVO" resultType="int">
			select count(*)
			from GATH_BUY_TBL
			where GATH_NUM=#{GATH_NUM} 
			and guestid = #{GUESTID}
		</select>
		
		
		<!-- 계 인원 체크 -->
		<select id="gath_count" parameterType="int" resultType="int">
		select count(*)
		from GATH_BUY_TBL
		where GATH_NUM=#{GATH_NUM} 
		</select>
	
		<!-- 계 모집완료 -->
		<update id="gath_compl" parameterType="int">
			update gath_tbl
			set gath_state='1'
			where GATH_NUM=#{GATH_NUM}  
		</update>
		
		<!--회원 계 목록 -->
    	<select id="gath_melist" resultType="com.spring.hexagon.vo.GatherVO">
    		select g.* 
			from gath_tbl g join gath_buy_tbl b
			on g.gath_num= b.gath_num
			where b.guestid=#{guestid}
    	</select>
		
		<!-- 계 퇴장 -->
		<select id="gath_turn" parameterType="com.spring.hexagon.vo.Gath_buyVO" resultType="String">
			select GATH_TURN
			from GATH_BUY_TBL 
			where GATH_NUM=#{GATH_NUM}
	    	and guestid= #{GUESTID}
		</select>
		
    	<delete id="gath_out" parameterType="com.spring.hexagon.vo.Gath_buyVO">
    		delete GATH_BUY_TBL
    		where GATH_NUM=#{GATH_NUM}
    		and guestid= #{GUESTID}
    	</delete>
    	<update id="gath_out2" parameterType="java.util.Map">
			update gath_tbl
			set ${GATH_TURN} = null
			where GATH_NUM=#{GATH_NUM}
		</update>
		
    	
    </mapper>